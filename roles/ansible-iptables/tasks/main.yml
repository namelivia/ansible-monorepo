---
- name: 'Check mandatory variables are defined'
  assert:
    that:
      - exposed_ports is defined

- name: Install required system packages
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: true
  loop:
    - 'iptables-persistent'

- name: "Allow port for VPN addresses only"
  ansible.builtin.iptables:
    action: "insert"
    chain: DOCKER-USER
    protocol: tcp
    in_interface: eth0
    destination_port: "{{ item }}"
    source: '!192.168.254.0/24'
    jump: DROP
  with_items: "{{ exposed_ports }}"

- name: "Persist iptables rules"
  command: "iptables-save > /etc/iptables/rules.v4"
  register: iptables_save
  changed_when: iptables_save.rc != 0
